name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download LOVE APK
      run: |
        wget https://github.com/love2d/love-android/releases/download/11.5/love-11.5-android.apk
        
    - name: Create .love file
      run: |
        zip -r game.love . -x "*.git*" "*.github*"
        
    - name: Setup Android tools
      run: |
        sudo apt-get update
        sudo apt-get install -y apktool zipalign
        wget https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar
        
    - name: Build APK
      run: |
        apktool d love-11.5-android.apk -o love_decoded
        mkdir -p love_decoded/assets
        cp game.love love_decoded/assets/
        apktool b love_decoded -o openhexagon-unsigned.apk
        java -jar uber-apk-signer-1.3.0.jar --apks openhexagon-unsigned.apk
        
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: OpenHexagon-Android
        path: openhexagon-unsigned-aligned-signed.apk
